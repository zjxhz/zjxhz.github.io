---
layout: post
title: 人脸识别 
description: 
category: articles
tags: 
---
因为要做机器学习的美女识别，需要用到大量的人脸图片作为训练数据。网上可以搜到的图片一般不是简单地包含一张人脸，而是会带有背景。

![苍井空](/images/cangjingkong.jpg)

为了算法的效率和准确度，这些背景需要被去除。背景图片是一种「噪音」，可能对算法造成干扰。比如，算法可能会倾向于把背景相似的图片划分到同一种类别中。


![苍井空头像](/images/cangjingkong_cropped.png)

当然，人脸识别已经不是一种新的技术。网上有很多的软件和工具可以帮我们做到这一点。比如Face++提供的Web API，以下是几张他们网站的截图：

![fpp01](/images/fpp01.png)

![fpp02.png](/images/fpp02.png)

Face++是一家中国的企业，技术的先进性和其API的易用性看起来都很不错。从它返回的API看，不仅可以找到图中的所有人脸和其「关键点」，还有包括比如性别，笑脸，年龄，头部角度，眼镜检测等很多功能。我一开始的需求是：

* 找到图中的人脸
* 摆正头部（即调整头部角度）
* 缩放为固定的大小并将头部置于正中
* 保存图片作为下一步的处理输入

摆正头部的例子（上：原图。下：摆正）如下。

![摆正前](/images/xjp_r0.png)
![摆正后](/images/xjp_r1.png)

Face++的API返回的数据是足够丰富了，可是我没有看到相关的图像处理部分（也就是后面两个需求）。于是我找到了dlib这个库。这是一个用C++写的类库，同时提供Python的接口。为了「珍爱生命」，我当然选择用Python。无奈，安装的过程缺这少那，一下子没成功。于是我不得不用C++来试试，这后来证明了是一系列噩梦的开始。我还想，大学的时候C++的考试和课程设计我可都是优秀呢，而且C++也是我工作后用的第一个语言。事实证明，我太幼稚了。C++还是一如既往地难用，特别是对于一个已经十多年没用了的人。我不禁又想起了那个「二十一天学习C++」的漫画：

![learncppin21days.jpg](/images/learncppin21days.jpg)

举几个C++为什么难用的例子：

* 没法用一行简单地代码创建一个目录！虽然你可以直接系统调用，但那将不是跨平台的，这对于一个Java程序员而言是不能接受的。为此，你不得不下载一个100多M的大家伙，Boost，就为了干这个。
* 程序经常莫名其妙地挂掉。有责热心的类库提供者好歹给你提供了断言，让你知道大概在什么地方出了什么错。可是C++有太多的「未定义行为」，有时候什么错误也不显示，只有一个segment fault。
* 没有在抛出异常的时候显示错误堆栈。有人还在StackOverflow孜孜不倦地教诲，说这「既慢也没有必要」。Excuse me?

好吧，我承认C++我是菜鸟。也许这些方面都有很简单的解决办法。可是，我需要一个菜鸟也可以快速上手，可以「快且脏」（Quick and Dirty）的方式帮我完成工作的语言。而C++显然不是。

离题了。

不管怎么说，用dlib实现上面的几个需求还是比较简单的（如果不算C++本身的复杂性），只需要简单地几个API调用。在其网站上也有相当详细的示例代码。相信你很容易就能看懂，并且正常运行（才怪哩）。我看了下其实现的原理，基本上是用了一种叫HOG的方法来探测物体的边界并编码，然后用一种线性的机器学习方法（应该是SVM - 支持向量机）来做分类识别。也许这些术语听起来比较陌生，不过没关系，这里我们只是需要得到它生成的图片，具体是怎么做到的，我们并不十分关心。但是，有意思的是，在能够对人脸进行检测并得到面部关键点之后，可以做很多非常有趣的脸部特效。比如：平均脸。

下面这张图是三位领袖的平均脸：

![平均脸](/images/face_average.png)

还有一些很有趣的应用，例如面部替换。想想，如果可以把（小）电影中男（或女）主角换成你想要的那个人……一定已经有人开发了这样的应用吧！