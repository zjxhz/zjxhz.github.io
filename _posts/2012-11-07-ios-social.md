---
layout: post
title: iOS开发：应用如何绑定社交账号
description: 介绍如何使用社交账号如新浪微博实现免注册登录
category: articles
tags: [iOS, social, weibo, 微博，账号]
---

这里以新浪微博为例。你首先应当参考的当然是新浪的[开放平台文档](http://open.weibo.com/)，然后是阅读其SDK文档和示例代码。

关于基本的流程，OAuth的原理，如何微博分享等官方文档和网上的文章讲得已经比较多，不再赘述。这里只讲一些我遇到的一些问题，当时似乎也没有很好的资料。

### 应用提供独立注册账号，也提供微博登录（或绑定），该如何处理？

网上大多数文章只讲到了如何引导用户通过授权，获得access token（访问码）后进行分享。如果应用本身也有用户账号（比如需要记录用户的订单，消息等），那么应用是否应该为以微博登录的用户自动创建一个账号呢？这分几种情况：

- 用户处于未登录状态：如果该微博账号是首次登录，后台需要为其创建一个账号，并绑定应用账号和微博账号。这里后台还应该去获取该微博账号关联的，你所需的其他信息，如昵称，头像，签名等，以简化用户的注册流程。如果该微博账号不是第一次登录（如在其他手机登录或者授权过期），那么后台需要找到对应的应用账户，并为其登录（到应用中）。我遇到的一个问题是：后台如何知道该微博账号关联到哪个应用账号？后面会单独说明这个问题。
- 如果用户已经以独立账号登录，希望手动绑定微博账号（或者在微博分享前应用自动弹出微博授权窗口）：应用绑定这两个账户即可（当然后台还需要检查该微博账号没有和其他账号绑定）。

### 后台如何绑定微博账号到应用账号？

我一开始的做法是：手机端引导用户完成微博登录授权，获取到access token和微博用户ID，根据access token和用户ID来查询其他的信息（如昵称 ，头像），然后手机端向后台发送一个包含了用户信息的请求已完成注册或者绑定。这里后台不需要向新浪服务器交互。

然而这样做有一个问题 ：手机端提供的微博用户ID是一个唯一标识该微博用户的信息。而ID是一个公开的信息，很容易就可以查询到。所以任何一个客户端（不一定是手机，也可以用比如curl向服务器发送一个简单的请求）都可以宣称自己是某个微博用户，只要他知道这个用户的ID。所以我一开始向服务器同时上传了access token，只有token也一样才匹配某个应用用户。后来才知道token是会过期的，也就是会变的。所以有可能后面某次微博登录就找不到以前的那个用户了，后台会认为这是一个新的微博账号。

正确的做法应该是：手机端在微博登录后应该向后台发送access token，后台根据这个access token来向新浪服务器查询用户ID，以及其他个人信息（或者使用回调？）。

听起来好像很简单，但是思考的过程却并不顺利。让我陷入误区的一个原因是，手机端在完成授权之后，SDK直接提供了用户ID，当时想当然地就想拿这个ID来做点什么，而没有考虑到服务器端应该重新去查询，而不应该信任手机端提供的这个ID.
